package history

import (
	"os"
	"testing"
	"time"

	"github.com/uber/cadence/common"
	"github.com/uber/cadence/common/persistence"

	"encoding/hex"

	"encoding/json"

	log "github.com/Sirupsen/logrus"
	"github.com/stretchr/testify/suite"
	"github.com/uber-common/bark"
	workflow "github.com/uber/cadence/.gen/go/shared"
)

type (
	timerBuilderProcessorSuite struct {
		suite.Suite
		tb     *timerBuilder
		logger bark.Logger
	}
)

func TestTimerBuilderSuite(t *testing.T) {
	s := new(timerBuilderProcessorSuite)
	suite.Run(t, s)
}

func (s *timerBuilderProcessorSuite) SetupSuite() {
	if testing.Verbose() {
		log.SetOutput(os.Stdout)
	}
	logger := log.New()
	//logger.Level = log.DebugLevel
	s.logger = bark.NewLoggerFromLogrus(logger)
	s.tb = newTimerBuilder(&localSeqNumGenerator{counter: 1}, s.logger)
}

func (s *timerBuilderProcessorSuite) TestTimerBuilderSingleUserTimer() {
	tb := newTimerBuilder(&localSeqNumGenerator{counter: 1}, s.logger)

	// Add one timer.
	msb := newMutableStateBuilder(s.logger)
	t1, err := tb.AddUserTimer("tid1", 1, 201, msb)
	s.Nil(err)
	s.NotNil(t1)
	s.True(t1.GetTaskID() > 0)
	s.Equal(int64(201), t1.(*persistence.UserTimerTask).EventID)
	s.Equal(t1.GetTaskID(), t1.(*persistence.UserTimerTask).TaskID)

	isRunning, ti := msb.GetUserTimer("tid1")
	s.True(isRunning)
	s.NotNil(ti)
	s.Equal(int64(201), ti.StartedID)
	s.Equal(t1.GetTaskID(), ti.TaskID)
	s.Equal("tid1", ti.TimerID)
	s.False(ti.ExpiryTime.IsZero())
}

func (s *timerBuilderProcessorSuite) TestTimerBuilderMulitpleUserTimer() {
	tb := newTimerBuilder(&localSeqNumGenerator{counter: 1}, s.logger)

	// Add two timers. (before and after)
	tp := &persistence.TimerInfo{TimerID: "tid1", StartedID: 201, TaskID: 101, ExpiryTime: time.Now().Add(10 * time.Second)}
	timerInfos := map[string]*persistence.TimerInfo{"tid1": tp}
	msb := newMutableStateBuilder(s.logger)
	msb.Load(nil, timerInfos)
	t1, err := tb.AddUserTimer("tid-before", 1, 202, msb)
	s.Nil(err)
	s.NotNil(t1)
	s.True(t1.GetTaskID() > 0)

	timerInfos = map[string]*persistence.TimerInfo{"tid1": tp}
	msb = newMutableStateBuilder(s.logger)
	msb.Load(nil, timerInfos)
	t1, err = tb.AddUserTimer("tid-after", 15, 203, msb)
	s.Nil(err)
	s.Nil(t1) // we don't get any timer since there is one in progress.

	// -- timer wth out a timer task.
	tp2 := &persistence.TimerInfo{TimerID: "tid1", StartedID: 201, TaskID: emptyTimerID, ExpiryTime: time.Now().Add(10 * time.Second)}
	timerInfos = map[string]*persistence.TimerInfo{"tid1": tp2}
	msb = newMutableStateBuilder(s.logger)
	msb.Load(nil, timerInfos)
	t1, err = tb.AddUserTimer("tid-after", 15, 203, msb)
	s.Nil(err)
	s.NotNil(t1)
	s.Equal(int64(201), t1.(*persistence.UserTimerTask).EventID)
	s.Equal(t1.GetTaskID(), t1.(*persistence.UserTimerTask).TaskID)

	isRunning, ti := msb.GetUserTimer("tid-after")
	s.True(isRunning)
	s.NotNil(ti)
	s.Equal(int64(emptyTimerID), ti.TaskID)
	s.Equal(int64(203), ti.StartedID)
}

func (s *timerBuilderProcessorSuite) TestTimerBuilderDuplicateTimerID() {
	tb := newTimerBuilder(&localSeqNumGenerator{counter: 1}, s.logger)
	tp := &persistence.TimerInfo{TimerID: "tid-exist", StartedID: 201, TaskID: 101, ExpiryTime: time.Now().Add(10 * time.Second)}
	timerInfos := map[string]*persistence.TimerInfo{"tid-exist": tp}
	msb := newMutableStateBuilder(s.logger)
	msb.Load(nil, timerInfos)
	t1, err := tb.AddUserTimer("tid-exist", 1, 202, msb)
	s.NotNil(err)
	s.Nil(t1)
}

func (s *timerBuilderProcessorSuite) TestDecodeHistory() {
	historyString := "5b7b226576656e744964223a312c2274696d657374616d70223a313438363639303836303638303736383335322c226576656e7454797065223a22576f726b666c6f77457865637574696f6e53746172746564222c22776f726b666c6f77457865637574696f6e537461727465644576656e7441747472696275746573223a7b22776f726b666c6f7754797065223a7b226e616d65223a22737472657373576f726b666f77227d2c227461736b4c697374223a7b226e616d65223a22746573745461736b4c697374227d2c22696e707574223a2265794a4461474670626c4e6c6358566c626d4e6c496a6f304c434a4259335270646d6c3065564e735a57567754576c75496a6f784d4441774d4441774d4441774c434a4259335270646d6c3065564e735a57567754574634496a6f314d4441774d4441774d44417766513d3d222c22657865637574696f6e5374617274546f436c6f736554696d656f75745365636f6e6473223a31302c227461736b5374617274546f436c6f736554696d656f75745365636f6e6473223a31302c226964656e74697479223a223931303335406164686f6330312d6463613140746573745461736b4c697374227d7d2c7b226576656e744964223a322c2274696d657374616d70223a313438363639303836303638303738363531392c226576656e7454797065223a224465636973696f6e5461736b5363686564756c6564222c226465636973696f6e5461736b5363686564756c65644576656e7441747472696275746573223a7b227461736b4c697374223a7b226e616d65223a22746573745461736b4c697374227d2c227374617274546f436c6f736554696d656f75745365636f6e6473223a31307d7d2c7b226576656e744964223a332c2274696d657374616d70223a313438363639303836363536363030323936322c226576656e7454797065223a224465636973696f6e5461736b53746172746564222c226465636973696f6e5461736b537461727465644576656e7441747472696275746573223a7b227363686564756c65644576656e744964223a322c226964656e74697479223a223931303335406164686f6330312d6463613140746573745461736b4c697374227d7d2c7b226576656e744964223a342c2274696d657374616d70223a313438363639303836373139313030333430312c226576656e7454797065223a224465636973696f6e5461736b436f6d706c65746564222c226465636973696f6e5461736b436f6d706c657465644576656e7441747472696275746573223a7b227363686564756c65644576656e744964223a322c22737461727465644576656e744964223a332c226964656e74697479223a223931303335406164686f6330312d6463613140746573745461736b4c697374227d7d2c7b226576656e744964223a352c2274696d657374616d70223a313438363639303836373139313030373230392c226576656e7454797065223a2241637469766974795461736b5363686564756c6564222c2261637469766974795461736b5363686564756c65644576656e7441747472696275746573223a7b2261637469766974794964223a2230222c22616374697669747954797065223a7b226e616d65223a22736c6565704163746976697479227d2c227461736b4c697374223a7b226e616d65223a22746573745461736b4c697374227d2c22696e707574223a226533303d222c227363686564756c65546f436c6f736554696d656f75745365636f6e6473223a302c227363686564756c65546f537461727454696d656f75745365636f6e6473223a302c227374617274546f436c6f736554696d656f75745365636f6e6473223a302c2268656172746265617454696d656f75745365636f6e6473223a302c226465636973696f6e5461736b436f6d706c657465644576656e744964223a347d7d2c7b226576656e744964223a362c2274696d657374616d70223a313438363639303836373831343335363938342c226576656e7454797065223a2241637469766974795461736b53746172746564222c2261637469766974795461736b537461727465644576656e7441747472696275746573223a7b227363686564756c65644576656e744964223a352c226964656e74697479223a223931303335406164686f6330312d6463613140746573745461736b4c697374227d7d2c7b226576656e744964223a372c2274696d657374616d70223a313438363639303836373930303930303236332c226576656e7454797065223a2241637469766974795461736b436f6d706c65746564222c2261637469766974795461736b436f6d706c657465644576656e7441747472696275746573223a7b227363686564756c65644576656e744964223a352c22737461727465644576656e744964223a362c226964656e74697479223a22227d7d2c7b226576656e744964223a382c2274696d657374616d70223a313438363639303836373930303930353932332c226576656e7454797065223a224465636973696f6e5461736b5363686564756c6564222c226465636973696f6e5461736b5363686564756c65644576656e7441747472696275746573223a7b227461736b4c697374223a7b226e616d65223a22746573745461736b4c697374227d2c227374617274546f436c6f736554696d656f75745365636f6e6473223a31307d7d2c7b226576656e744964223a392c2274696d657374616d70223a313438363639303836383031393938363536362c226576656e7454797065223a224465636973696f6e5461736b53746172746564222c226465636973696f6e5461736b537461727465644576656e7441747472696275746573223a7b227363686564756c65644576656e744964223a382c226964656e74697479223a223931303335406164686f6330312d6463613140746573745461736b4c697374227d7d2c7b226576656e744964223a31302c2274696d657374616d70223a313438363639303836383130363532323533322c226576656e7454797065223a224465636973696f6e5461736b436f6d706c65746564222c226465636973696f6e5461736b436f6d706c657465644576656e7441747472696275746573223a7b227363686564756c65644576656e744964223a382c22737461727465644576656e744964223a392c226964656e74697479223a223931303335406164686f6330312d6463613140746573745461736b4c697374227d7d2c7b226576656e744964223a31312c2274696d657374616d70223a313438363639303836383130363532363239332c226576656e7454797065223a2241637469766974795461736b5363686564756c6564222c2261637469766974795461736b5363686564756c65644576656e7441747472696275746573223a7b2261637469766974794964223a2231222c22616374697669747954797065223a7b226e616d65223a22736c6565704163746976697479227d2c227461736b4c697374223a7b226e616d65223a22746573745461736b4c697374227d2c22696e707574223a226533303d222c227363686564756c65546f436c6f736554696d656f75745365636f6e6473223a302c227363686564756c65546f537461727454696d656f75745365636f6e6473223a302c227374617274546f436c6f736554696d656f75745365636f6e6473223a302c2268656172746265617454696d656f75745365636f6e6473223a302c226465636973696f6e5461736b436f6d706c657465644576656e744964223a31307d7d2c7b226576656e744964223a31322c2274696d657374616d70223a313438363639303836383530383931373434322c226576656e7454797065223a2241637469766974795461736b53746172746564222c2261637469766974795461736b537461727465644576656e7441747472696275746573223a7b227363686564756c65644576656e744964223a31312c226964656e74697479223a223931303335406164686f6330312d6463613140746573745461736b4c697374227d7d2c7b226576656e744964223a31332c2274696d657374616d70223a313438363639303836383639393339373833362c226576656e7454797065223a2241637469766974795461736b436f6d706c65746564222c2261637469766974795461736b436f6d706c657465644576656e7441747472696275746573223a7b227363686564756c65644576656e744964223a31312c22737461727465644576656e744964223a31322c226964656e74697479223a22227d7d2c7b226576656e744964223a31342c2274696d657374616d70223a313438363639303836383639393430303438342c226576656e7454797065223a224465636973696f6e5461736b5363686564756c6564222c226465636973696f6e5461736b5363686564756c65644576656e7441747472696275746573223a7b227461736b4c697374223a7b226e616d65223a22746573745461736b4c697374227d2c227374617274546f436c6f736554696d656f75745365636f6e6473223a31307d7d2c7b226576656e744964223a31352c2274696d657374616d70223a313438363639303836393330313330383234362c226576656e7454797065223a224465636973696f6e5461736b53746172746564222c226465636973696f6e5461736b537461727465644576656e7441747472696275746573223a7b227363686564756c65644576656e744964223a31342c226964656e74697479223a223931303335406164686f6330312d6463613140746573745461736b4c697374227d7d2c7b226576656e744964223a31362c2274696d657374616d70223a313438363639303836393438303335383039332c226576656e7454797065223a224465636973696f6e5461736b436f6d706c65746564222c226465636973696f6e5461736b436f6d706c657465644576656e7441747472696275746573223a7b227363686564756c65644576656e744964223a31342c22737461727465644576656e744964223a31352c226964656e74697479223a223931303335406164686f6330312d6463613140746573745461736b4c697374227d7d2c7b226576656e744964223a31372c2274696d657374616d70223a313438363639303836393438303336333133392c226576656e7454797065223a2241637469766974795461736b5363686564756c6564222c2261637469766974795461736b5363686564756c65644576656e7441747472696275746573223a7b2261637469766974794964223a2232222c22616374697669747954797065223a7b226e616d65223a22736c6565704163746976697479227d2c227461736b4c697374223a7b226e616d65223a22746573745461736b4c697374227d2c22696e707574223a226533303d222c227363686564756c65546f436c6f736554696d656f75745365636f6e6473223a302c227363686564756c65546f537461727454696d656f75745365636f6e6473223a302c227374617274546f436c6f736554696d656f75745365636f6e6473223a302c2268656172746265617454696d656f75745365636f6e6473223a302c226465636973696f6e5461736b436f6d706c657465644576656e744964223a31367d7d2c7b226576656e744964223a31382c2274696d657374616d70223a313438363639303837303030393038313635342c226576656e7454797065223a2241637469766974795461736b53746172746564222c2261637469766974795461736b537461727465644576656e7441747472696275746573223a7b227363686564756c65644576656e744964223a31372c226964656e74697479223a223931303335406164686f6330312d6463613140746573745461736b4c697374227d7d2c7b226576656e744964223a31392c2274696d657374616d70223a313438363639303837303230313737383431322c226576656e7454797065223a2241637469766974795461736b436f6d706c65746564222c2261637469766974795461736b436f6d706c657465644576656e7441747472696275746573223a7b227363686564756c65644576656e744964223a31372c22737461727465644576656e744964223a31382c226964656e74697479223a22227d7d2c7b226576656e744964223a32302c2274696d657374616d70223a313438363639303837303230313738313730302c226576656e7454797065223a224465636973696f6e5461736b5363686564756c6564222c226465636973696f6e5461736b5363686564756c65644576656e7441747472696275746573223a7b227461736b4c697374223a7b226e616d65223a22746573745461736b4c697374227d2c227374617274546f436c6f736554696d656f75745365636f6e6473223a31307d7d2c7b226576656e744964223a32312c2274696d657374616d70223a313438363639303837303530313036353437392c226576656e7454797065223a224465636973696f6e5461736b53746172746564222c226465636973696f6e5461736b537461727465644576656e7441747472696275746573223a7b227363686564756c65644576656e744964223a32302c226964656e74697479223a223931303335406164686f6330312d6463613140746573745461736b4c697374227d7d2c7b226576656e744964223a32322c2274696d657374616d70223a313438363639303837303634323235363633332c226576656e7454797065223a224465636973696f6e5461736b436f6d706c65746564222c226465636973696f6e5461736b436f6d706c657465644576656e7441747472696275746573223a7b227363686564756c65644576656e744964223a32302c22737461727465644576656e744964223a32312c226964656e74697479223a223931303335406164686f6330312d6463613140746573745461736b4c697374227d7d2c7b226576656e744964223a32332c2274696d657374616d70223a313438363639303837303634323236333339392c226576656e7454797065223a2241637469766974795461736b5363686564756c6564222c2261637469766974795461736b5363686564756c65644576656e7441747472696275746573223a7b2261637469766974794964223a2233222c22616374697669747954797065223a7b226e616d65223a22736c6565704163746976697479227d2c227461736b4c697374223a7b226e616d65223a22746573745461736b4c697374227d2c22696e707574223a226533303d222c227363686564756c65546f436c6f736554696d656f75745365636f6e6473223a302c227363686564756c65546f537461727454696d656f75745365636f6e6473223a302c227374617274546f436c6f736554696d656f75745365636f6e6473223a302c2268656172746265617454696d656f75745365636f6e6473223a302c226465636973696f6e5461736b436f6d706c657465644576656e744964223a32327d7d2c7b226576656e744964223a32342c2274696d657374616d70223a313438363639303837303931323936383039342c226576656e7454797065223a2241637469766974795461736b53746172746564222c2261637469766974795461736b537461727465644576656e7441747472696275746573223a7b227363686564756c65644576656e744964223a32332c226964656e74697479223a223931303335406164686f6330312d6463613140746573745461736b4c697374227d7d2c7b226576656e744964223a32352c2274696d657374616d70223a313438363639303837313030383230303832382c226576656e7454797065223a2241637469766974795461736b436f6d706c65746564222c2261637469766974795461736b436f6d706c657465644576656e7441747472696275746573223a7b227363686564756c65644576656e744964223a32332c22737461727465644576656e744964223a32342c226964656e74697479223a22227d7d2c7b226576656e744964223a32362c2274696d657374616d70223a313438363639303837313030383231313333352c226576656e7454797065223a224465636973696f6e5461736b5363686564756c6564222c226465636973696f6e5461736b5363686564756c65644576656e7441747472696275746573223a7b227461736b4c697374223a7b226e616d65223a22746573745461736b4c697374227d2c227374617274546f436c6f736554696d656f75745365636f6e6473223a31307d7d2c7b226576656e744964223a32372c2274696d657374616d70223a313438363639303837313539373039353037332c226576656e7454797065223a224465636973696f6e5461736b53746172746564222c226465636973696f6e5461736b537461727465644576656e7441747472696275746573223a7b227363686564756c65644576656e744964223a32362c226964656e74697479223a223931303335406164686f6330312d6463613140746573745461736b4c697374227d7d2c7b226576656e744964223a32382c2274696d657374616d70223a313438363639303838313539353138313235372c226576656e7454797065223a224465636973696f6e5461736b54696d65644f7574222c226465636973696f6e5461736b54696d65644f75744576656e7441747472696275746573223a7b227363686564756c65644576656e744964223a32362c22737461727465644576656e744964223a32372c2274696d656f757454797065223a2253544152545f544f5f434c4f5345227d7d2c7b226576656e744964223a32392c2274696d657374616d70223a313438363639303838313539353232343037322c226576656e7454797065223a224465636973696f6e5461736b5363686564756c6564222c226465636973696f6e5461736b5363686564756c65644576656e7441747472696275746573223a7b227461736b4c697374223a7b226e616d65223a22746573745461736b4c697374227d2c227374617274546f436c6f736554696d656f75745365636f6e6473223a31307d7d2c7b226576656e744964223a33302c2274696d657374616d70223a313438363639303838323534363433353137392c226576656e7454797065223a224465636973696f6e5461736b53746172746564222c226465636973696f6e5461736b537461727465644576656e7441747472696275746573223a7b227363686564756c65644576656e744964223a32392c226964656e74697479223a223931303335406164686f6330312d6463613140746573745461736b4c697374227d7d2c7b226576656e744964223a33312c2274696d657374616d70223a313438363639303838323536333534383435372c226576656e7454797065223a224465636973696f6e5461736b436f6d706c65746564222c226465636973696f6e5461736b436f6d706c657465644576656e7441747472696275746573223a7b227363686564756c65644576656e744964223a32392c22737461727465644576656e744964223a33302c226964656e74697479223a223931303335406164686f6330312d6463613140746573745461736b4c697374227d7d2c7b226576656e744964223a33322c2274696d657374616d70223a313438363639303838323536333539313934362c226576656e7454797065223a22576f726b666c6f77457865637574696f6e436f6d706c65746564222c22776f726b666c6f77457865637574696f6e436f6d706c657465644576656e7441747472696275746573223a7b226465636973696f6e5461736b436f6d706c657465644576656e744964223a33317d7d5d"
	data, err := hex.DecodeString(historyString)
	var historyEvents []*workflow.HistoryEvent
	err = json.Unmarshal(data, &historyEvents)
	if err != nil {
		s.logger.Errorf("DecodeString failed with error: %+v", err)
		panic("Failed deserialization of history")
	}

	history := workflow.NewHistory()
	history.Events = historyEvents

	common.PrettyPrintHistory(history, s.logger)
}

func (s *timerBuilderProcessorSuite) TestDecodeKey() {
	taskID := SequenceID(1486597582082801667)
	expiryTime, _ := DeconstructTimerKey(taskID)
	s.logger.Infof("Timer Sequence ID: %s, expiry: %v", SequenceID(taskID), time.Unix(0, expiryTime).UTC())
}
